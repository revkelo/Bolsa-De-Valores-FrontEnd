<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar PDF con Datos de JSON</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.js"></script>
</head>
<body>
    <button id="generarPdf">Generar PDF</button>

    <script>
        document.getElementById("generarPdf").addEventListener("click", function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            cargarLogo(doc);
            agregarTitulo(doc);

            // Crear un array con todas las promesas de obtención y generación de tablas
            const promesas = [
                agregarDatosPersonales(doc),
                obtenerDatosComisionistaYGenerarTabla(doc, 3, 'Transacciones del Comisionista')
            ];

            // Esperar a que todas las promesas se resuelvan antes de abrir el PDF
            Promise.all(promesas).then(() => {
                abrirPDFEnVentana(doc);
            }).catch(error => {
                console.error("Error al generar las tablas:", error);
            });
        });

        function cargarLogo(doc) {
            const logo = new Image();
            logo.src = "./images/logo.png";
            logo.onload = function () {
                doc.addImage(logo, 'JPEG', 10, 13, 50, 10);
            }
        }

        function agregarTitulo(doc) {
            doc.setFontSize(20);
            doc.text('Informe', 105, 20, null, null, 'center');
        }

        function agregarDatosPersonales(doc) {
            return new Promise((resolve, reject) => {
                fetch('http://localhost:8080/api/inversionista/2')
                    .then(response => response.json())
                    .then(data => {
                        doc.setFontSize(12);
                        doc.text('Datos Personales:', 10, 40);
                        doc.text('Nombre: ' + data.usuario.nombre, 10, 50);
                        doc.text('Email: ' + data.usuario.email, 10, 60);
                        doc.text('País: ' + data.pais, 10, 70);
                        resolve();
                    })
                    .catch(error => {
                        console.error('Error al obtener los datos:', error);
                        reject(error);
                    });
            });
        }

        function obtenerDatosComisionistaYGenerarTabla(doc, idcomisionista, tablaTitulo) {
            const url = `http://localhost:8080/api/transaccion/comisionista/${idcomisionista}/transacciones`;
            return fetch(url)
                .then(response => {
                    if (response.status === 404) {
                        return [];
                    } else if (!response.ok) {
                        throw new Error('Error en la solicitud de datos');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && Array.isArray(data) && data.length > 0) {
                        const headers = Object.keys(data[0]);
                        const tableData = data.map(item => Object.values(item));
                        agregarTabla(doc, headers, tableData, tablaTitulo);
                    }
                })
                .catch(error => {
                    alert("Hubo un problema al obtener los datos. Intenta nuevamente.");
                });
        }

        function agregarTabla(doc, headers, tableData, tablaTitulo) {
            let fontSize = 8;
            let cellPadding = 4;

            if (tableData.length > 10) {
                fontSize = 7;
                cellPadding = 3;
            }

            doc.setFontSize(14);
            doc.text(tablaTitulo, 10, doc.autoTable.previous ? doc.autoTable.previous.finalY + 10 : 80);

            doc.autoTable({
                startY: doc.autoTable.previous ? doc.autoTable.previous.finalY + 20 : 90,
                head: [headers],
                body: tableData,
                theme: 'grid',
                styles: {
                    cellPadding: cellPadding,
                    fontSize: fontSize,
                    textColor: [0, 0, 0],
                    lineColor: [0, 0, 0],
                    lineWidth: 0.1
                },
                headStyles: {
                    fillColor: [0, 0, 0],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                bodyStyles: {
                    fillColor: [255, 255, 255],
                },
                margin: { top: 40, left: 10, bottom: 10, right: 10 },
                pageBreak: 'auto',
            });
        }

        function abrirPDFEnVentana(doc) {
            const pdfOutput = doc.output('dataurlnewwindow');
            window.open(pdfOutput, '_blank');
        }
    </script>
</body>
</html>
